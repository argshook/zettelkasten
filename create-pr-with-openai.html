<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>arij.us - create-pr-with-openai</title>
    <link rel="stylesheet" href="https://arij.us/statics/style.css" />
  </head>
  <body>
    <main>
      <header class="header">
        <a class="header-title" href="https://arij.us">
          <div class="page-title">arij.us</div>
          <div class="page-subtitle">Digital Garden</div>
        </a>

        <nav class="menu">
          <ul>
            <li><a href="https://arij.us">Home</a></li>
            <li><a href="https://arij.us/about.html">About</a></li>
            <li><a href="https://arij.us/projects.html">Projects</a></li>
          </ul>
        </nav>
      </header>

      <article class="article">
        <h1 class="article-title">Turbocharging GitHub PR Creation with Python, OpenAI, and GitHub CLI</h1>
                <div class="last-modified">Last updated 2023-07-18</div>
        <p>Creating, reviewing, and merging pull requests (PRs) is an integral part of collaborative software development. These PRs, crafted for human understanding, should be easy to read and comprehend.</p>
<p>Developers who push numerous PRs daily can understand the taxing effort it takes to consistently pull-off comprehensive titles and descriptions. After writing great commit messages there should be no need to again write the PR description (essentially the same thing in a slightly different format).</p>
<p>Wouldn’t it be nice to automate these repetitive tasks without sacrificing clarity and consistency?</p>
<p>Facing this problem far too often I decided to automate the process of creating PRs. And not only just pushing code with <code>gh pr create</code>, but also generating values for title and description.</p>
<p>Using python as a glue to combine Git, GitHub CLI (<code>gh</code>), and OpenAI’s API, I ended up with a simple script.</p>
<p>I chose to put it as <code>,pr-create</code> command. Now this command is always available in my terminal session and the comma (<code>,</code>) at the start makes sure it will never clash with any other command. Neat!</p>
<h2 id="script-overview">Script Overview</h2>
<p>If you’re looking for code, find the complete script <a href="https://github.com/argshook/dotfiles/blob/master/.argsdotfiles/bin/%2Cpr-create">here in my dotfiles repo</a>. The script is quite straightforward and easy to copy and use. If you would like to use it, make sure <code>openai</code> and <code>yaspin</code> python modules are installed. This can be done with a quick <code>pip install openai yaspin</code></p>
<p><code>yaspin</code> is just for a spinner to indicate progress, just because I wanted a few sparks in my terminal. Feel free to adjust to fit your use case!</p>
<p>My script does three things:</p>
<ol type="1">
<li>Extracts the git log.</li>
<li>Summarizes the changes into a clear, concise title and description using OpenAI’s <code>gpt-3.5-turbo</code> model.</li>
<li>Pushes a PR to GitHub using the generated title and description.</li>
</ol>
<h3 id="extracting-the-git-log">Extracting the Git Log</h3>
<p>To obtain a history of changes, we first need to determine the base commit from which the current branch diverged. This is done using the <code>git merge-base</code> command:</p>
<pre class="python"><code>base_commit = subprocess.check_output(
    &quot;git merge-base HEAD $(git show-ref --verify --quiet refs/heads/main &amp;&amp; echo &#39;main&#39; || echo &#39;master&#39;)&quot;,
    shell=True,
    universal_newlines=True
).strip()</code></pre>
<p>After determining the base commit, then we use <code>git log --pretty</code> to format the log:</p>
<pre class="python"><code>output = subprocess.check_output(
    f&#39;git log --reverse --pretty=format:&quot;* %s%n%w(0,4,4)%b&quot; {base_commit}..HEAD&#39;,
    shell=True,
    universal_newlines=True
)</code></pre>
<p>This command retrieves the git log from the base commit to the current <code>HEAD</code>, formatting each commit as a list item and ensuring commit messages and bodies are properly indented.</p>
<h3 id="generating-the-title-and-description-with-openai">Generating the Title and Description with OpenAI</h3>
<p>The OpenAI <code>gpt-3.5-turbo</code> model is then used to generate a human-friendly title and description based on the git log. Using OpenAI API is a breeze with the official <code>openai</code> python module:</p>
<pre class="python"><code>response = openai.ChatCompletion.create(
    model=&#39;gpt-3.5-turbo&#39;,
    temperature=0.2,
    n=1,
    messages=[{&#39;role&#39;: &#39;user&#39;, &#39;content&#39;: prompt}]
)
output = response.choices[0].message.content.strip().strip(&#39;&quot;&#39;)</code></pre>
<p>Here, <code>prompt</code> is a string that instructs to generate a PR title or description from the git log. For instance, a <code>prompt</code> for the title might look like this:</p>
<pre class="python"><code>prompt = f&quot;You are an expert software engineer preparing the title of a PR. Summarize key changes into a short (max 100 chars) PR title from git log:\n\n{text}\n\n&quot;</code></pre>
<p>Here <code>text</code> is the git log obtained in the previous step.</p>
<h3 id="creating-the-pull-request">Creating the Pull Request</h3>
<p>Finally, we combine generated title and description to create a command for GitHub CLI to create the PR:</p>
<pre class="python"><code>command = f&#39;gh pr create --assignee @me --title {title} --body {body}&#39;</code></pre>
<p>Eventually this command is executed in the shell, creating the PR.</p>
<h2 id="conclusion">Conclusion</h2>
<p>By combining Python, OpenAI, and GitHub CLI, we’ve created a powerful tool that streamlines PR creation. It frees us from the tedious process of manually entering PR information and allows us to focus more on coding.</p>
<p>If you’d like to use or further explore this script, you can find the complete version <a href="https://github.com/argshook/dotfiles/blob/master/.argsdotfiles/bin/%2Cpr-create">here in my dotfiles repo</a>.</p>
      </article>
    </main>
  </body>
</html>
